name: CI

concurrency:
  group: ${{ github.repository }}-${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: '-C debuginfo=line-tables-only -C incremental=false'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.changes.outputs.code }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@master
      id: changes
      with:
        predicate-quantifier: 'every'
        filters: |
          code:
            - '**'
            - '!**.md'
            - '!docs/**'
            - '!.claude/**'
            - '!.gitignore'
            - '!.justfile'
            - '!LICENSE'
            - '!.github/workflows/pr.yml'
            - '!.github/workflows/release.yml'
            - '!.github/workflows/security.yml'
            - '!.github/dependabot.yml'
            - '!.github/labeler.yml'

  check:
    name: Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - name: Install Rust nightly (for formatting)
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo +nightly fmt -- --check

    - name: Run clippy
      run: cargo +stable clippy --profile ci --all-features --all-targets -- -D warnings

    - name: Build stable
      run: cargo +stable build --profile ci --all-features --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
    - uses: actions/checkout@v4

    # Docker Hub login for pulling images (avoids rate limits)
    # Supports multiple secret naming conventions for flexibility:
    #   - DOCKERHUB_USERNAME + DOCKERHUB_TOKEN (recommended, uses access token)
    #   - DOCKERHUB_USERNAME + DOCKERHUB_PASSWORD (legacy, uses password)
    #   - DOCKER_USERNAME + DOCKER_PASSWORD (original upstream convention)
    # Access tokens are preferred over passwords for security best practices.
    # See: https://docs.docker.com/security/for-developers/access-tokens/
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request' ||
          github.event.pull_request.head.repo.full_name == github.repository
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME || secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKERHUB_PASSWORD || secrets.DOCKER_PASSWORD }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate code coverage
      run: |
        cargo llvm-cov --features test-utils --workspace --lcov --output-path lcov.info \
         --ignore-filename-regex "(clickhouse-arrow-derive|errors|error_codes|examples|test-utils).*"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: lcov.info
        fail_ci_if_error: true
        disable_telem: true

  # Summary job that branch protection can depend on
  ci-success:
    name: CI Success
    needs: [changes, check, coverage]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          # If only docs changed, that's success
          if [[ "${{ needs.changes.outputs.code }}" == "false" ]]; then
            echo "Documentation-only change âœ…"
            exit 0
          fi

          if [[ "${{ needs.check.result }}" != "success" ]] || [[ "${{ needs.coverage.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
